<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Airfoil</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Cache-Control" content="no-cache">
    <script src="/static/js/jquery-3.1.1.min.js"></script>
    <script src="/static/js/get_user.js"></script>
    <script src='/static/js/tabular-input.min.js'></script>
    <link rel="stylesheet" href="/static/css/main.css" type="text/css"/>

    <link rel="import" href="/static/menu.html">
    <link type='text/css' rel='stylesheet' href='/static/css/tabular-input.css'/>
</head>
<style>
    #example {
        width: 240px;
    }
</style>
<body>

<div class="wrapper">
    <div id="header">
        <div id="header_user">
            <p class="user_hello">Добро пожаловать, </p>
            <p class="user_action"><a href="login.html" target="_blank"> </a></p>
        </div>
    </div>


    <div class="middle" id="middle">

        <div class="container">
            <div class="content" id="contentid">
                <div id="airfoilDetailInfo">
                    <form action="/rest/write/addAirfoil" method="post" enctype="multipart/form-data">
                        <label>
                            Название профиля
                            <input type="text" value="" name="name"/>
                        </label>
                        </Br>
                        <label>
                            Короткое название профиля
                            <input type="text" value="" name="ShortName"/>
                        </label>
                        </Br>
                        <label>
                            Детали
                            <input type="text" value="" name="Details"/>
                        </label>
                        </Br>
                        <label>
                            Выберите файл для построения графика профиля
                            <input class='fileInput' type="file" name="fileAirfoil"/>
                        </label>

                        </Br>
                        <label>
                            Выберите файлы построения графиков
                            <input class='fileInput' type="file" name="files" multiple="multiple"
                                   value="Выбрать файлы"/>
                        </label>
                        </Br>
                        <input type="submit"/>

                    </form>
                </div>

                <div id="addAirfoilWeb">
                    <label>
                        Название профиля
                        <input type="text" value="" name="airfoilName" id="airfoilName"/>
                    </label>
                    </Br>
                    <label>
                        Короткое название профиля
                        <input type="text" value="" name="ShortName" id="ShortName"/>
                    </label>
                    </Br>
                    <label>
                        Детали
                        <input type="text" value="" name="Details" id="Details"/>
                    </label>
                    </Br>
                    <input type="button" id="addTable" value="add table">
                </div>
                <input type="button" id="saveWab" value="add airfoil">

            </div>
        </div>

        <script>
            var number = 0;
            var link = document.querySelector('link[rel=import]');
            var content = link.import.querySelector('#menu');
            document.getElementById('middle').appendChild(content.cloneNode(true));

            document.getElementById("addTable").onclick = addTable;
            document.getElementById("saveWab").onclick = saveWab;


            function createLabel(id, value) {
                let label = document.createElement('label');
                label.id = id + number;
                label.innerText = value;
                var input = document.createElement('input');
                input.id = 'input_' + id + number;
                input.setAttribute('type', 'text');
                label.appendChild(input);
                label.appendChild(document.createElement('Br'));
                return label;
            }
            function addTable() {

                var Reynolds_number = createLabel('Reynolds_number', "Reynolds number");
                var Ncrit = createLabel('Ncrit', "Ncrit");
                var Mach = createLabel('Mach', "Mach");
                var MaxClCd = createLabel('MaxClCd', "Max Cl/Cd");
                var MaxClCdalpha = createLabel('MaxClCdalpha', "Max Cl/Cd alpha");


                var tableDiv = document.createElement('div');
                tableDiv.setAttribute("class", 'example');
                var btn = document.createElement('input');
                btn.setAttribute("type", 'button');
                btn.setAttribute("value", 'Add New Row');
                btn.setAttribute("onClick", 'javascript:$("#tabular' + number + '").tabularInput("addRow")');
                var btn2 = document.createElement('input');
                btn2.setAttribute("type", 'button');
                btn2.setAttribute("value", 'Delete Last Row');
                btn2.setAttribute("onClick", 'javascript:$("#tabular' + number + '").tabularInput("deleteRow")');

                var table = document.createElement('div');
                table.id = 'tabular' + number;

                tableDiv.appendChild(Reynolds_number);
                tableDiv.appendChild(Ncrit);
                tableDiv.appendChild(Mach);
                tableDiv.appendChild(MaxClCd);
                tableDiv.appendChild(MaxClCdalpha);
                tableDiv.appendChild(btn);
                tableDiv.appendChild(btn2);
                tableDiv.appendChild(document.createElement('Br'));
                tableDiv.appendChild(table);

                var addAirfoilWeb = document.getElementById('addAirfoilWeb');
                addAirfoilWeb.appendChild(tableDiv);
                jQuery('#tabular' + number).tabularInput({
                    'rows': 10,
                    'columns': 7,
                    'minRows': 10,
                    'newRowOnTab': true,
                    'columnHeads': ['alpha', 'CL', 'CD', 'CDp', 'CM', 'Top_Xtr', 'Bot_Xtr'],
                    'name': '',
                    'animate': true
                });
                number++;

            }

            function getTableItem(i, j, table) {
                return table['[' + i + '][' + j + ']'].value;
            }
            function tableLength(i) {
                return document.getElementById('tabular' + i).getElementsByTagName('tbody')[0].childElementCount
            }
            function saveWab() {
                let resultCSVList = [];
                for (let i = 0; i < number; i++) {
                    let resultCSV = "Xfoil polar. Reynolds number fixed. Mach  number fixed\n";
                    let airfoilName = document.getElementById('ShortName').value;
                    let Reynolds_number = document.getElementById('input_Reynolds_number' + i).value;
                    let fileName = "xf-" + airfoilName + "-" + Reynolds_number;
                    resultCSV += "Polar key," + fileName + "\n";
                    resultCSV += "Airfoil," + airfoilName + "\n";
                    resultCSV += "Reynolds number," + Reynolds_number + "\n";
                    resultCSV += "Ncrit," + document.getElementById('input_Ncrit' + i).value + "\n";
                    resultCSV += "Mach," + document.getElementById('input_Mach' + i).value + "\n";
                    resultCSV += "Max Cl/Cd," + document.getElementById('input_MaxClCd' + i).value + "\n";
                    resultCSV += "Max Cl/Cd alpha," + document.getElementById('input_MaxClCdalpha' + i).value + "\n";
                    resultCSV += "Url,url" + "\n";
                    resultCSV += "\n";
                    resultCSV += 'alpha,CL,CD,CDp,CM,Top_Xtr,Bot_Xtr\n';

                    let table = document.getElementById('tabular' + i).getElementsByTagName('*');
                    for (let j = 1; j <= tableLength(i); j++) {
                        for (let k = 0; k < 7; k++) {
                            resultCSV += getTableItem(k, j, table);
                            if (k != 6) {
                                resultCSV += ',';
                            }
                        }
                        resultCSV += '\n';
                    }
                    let resultCsvObj = {};
                    resultCsvObj["fileName"] = fileName;
                    resultCsvObj["data"] = resultCSV;

                    console.log(resultCSV);
                    resultCSVList[i] = resultCsvObj;
                }

                let data = {};
                data["airfoilName"] = $("#airfoilName").val();
                data["shortName"] = $("#ShortName").val();
                data["details"] = $("#Details").val();
                data["data"] = resultCSVList;
                console.log(data);
                $(document).ready(function () {
                    $.ajax({
                        type: "POST",
                        contentType: "application/json",
                        url: "/rest/write/addAirfoilForStringCsv",
                        data: JSON.stringify(data),
                        dataType: 'json',
                        timeout: 600000
                    });
                });
            }
        </script>

    </div>

    <div class="footer">
        footer
    </div>

</div>
</body>
</html>